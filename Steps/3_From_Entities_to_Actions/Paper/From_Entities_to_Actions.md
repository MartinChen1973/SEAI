# 从软件实体拆分软件行为的大语言模型实现方法

**摘要**. [**前后文**] 在需求拆的过程中，从实体（entity，对应数据库表）到行为（action，对应 API）是非常重要的一个步骤。然而在实践中，由于行为的数量比实体多很多，导致需求分析者常常直接使用实体作为需求单元（颗粒度过大），或者粗略地以增查改删 CRUD 替代实际的行为，导致后续的开发、测试人员难以在早期精准确认到底要开发哪些API。LLM 的出现为此过程的自动化实现带来了契机。 [**问题**] 行为拆分涉及到对物理世界的认知，造成大语言模型不能真正理解增查改删的概念；而极少有公开可用的需求文档可供研究，以及缺少客观的评价拆分效果的标准，都可能对 LLM 完成此任务带来困难。 [**方法**] 本文使用 LLM 和人工干预生成微调数据（作为 RAG 的输入），使用真实项目数据进行最终评估；通过尝试不同的提示词模板、效果评估参数，以使 LLM 能拆分出更加接近真实项目的结果。 [**结果**] 本论文评估了 3 种从简单到复杂的提示词，在不同的RAG数据量下的拆分结果。并通过设置损失函数的参数，令其拆分出略多于真实项目的行为，以防止遗漏。

**关键词**: 需求工程 · 生成式 AI · 提示词模式 · 提示工程 · 大型语言模型 · 软件需求拆分

# 简介 Introduction

用户故事是敏捷开发中最常使用的需求条目。从其语法“As a (role), I want to (do sth.), so that (要达到的目标)”中可以看出，在“do sth.”的位置必定会放一个动词来描述用户行为。因此，若能从需求文档中识别出用户的动词性行为，成为用户故事拆分中的一个关键环节。

SEAi 需求分析法可以可以帮助有效发现行为。它包含四个步骤：将一段需求表述成场景描述 Scenarios，在场景描述中识别并标注实体 Entities，从每个实体中拆分出对应的行为 Action（即增查改删 CRUD 等主语为用户的动词），识别每个行为可能的需求实例 instance。

有多达 100 家企业的 1500 个团队接受过 SEAi 方法的培训。经过 1 天的培训与练习，学员间、学员与讲师间在行为识别方面的偏差即可低至 15%左右。然而在实际研发过程中，由于行为的数量庞大（每个行为的总工作量大约是 5 人天左右），拆分、在工具中填写的过程较为繁琐，多数团队倾向于只拆分到实体 Entity 的层面（每个实体的总工作量大约是 28 人天左右），降低了拆分、管理工作量，但却造成后续开发、测试、集成与相应的跟踪工作的困难。

大语言模型的出现，使从实体到行为的拆分有可能自动化完成。其核心技术包括提示词优化、设置模板并准备适当的示例供 LLM 参考、选择恰当的指标评判拆分的结果。

# 实验步骤

本次实验遵循以下步骤：

第一步：准备人工标记过的数据
每组数据包括实体，从此实体中拆分出来的多个行为，例如：订单：创建，列表，详情，报表，支付，取消，删除
这些这些数据应该被人工标记过，并作为“完美数据”呈现，用于RAG输入（样例数据）、评判模型效果（评判数据）。

第二步：设计提示词
利用SEAi方法论的相关内容，设计提示词让LLM对给定的实体进行拆分，并输出为相应的格式。

第三步：RAG辅助微调
用大语言模型，对待拆分的实体进行判断，从标记数据中选出适当的实体-行为拆分数据，供大模型进行参考。

第四步：评价效果
基于拆分结果的数量、内容、顺序三点建立损失函数，使用评判数据作为输入，对大语言模型的结果进行评判。

# 第一步：准备人工标记过的数据

由于大部分需求文档都是不公开的，因此本文尝试了几种方法来准备需求数据。
注意，这里的数据并非是完整的文档，只需要实体与对应行为的拆分结果。以下就是一个可用的数据
订单：创建，列表，详情，报表，支付，取消，删除

1. AI生成
方法：利用ChatGPT或者类似模型生成实体-行为对应关系，再由一个需求分析专家进行修改。典型的提示词如：“请列出一个在线购物系统的所有实体和行为。每行包括一个实体及其行为，格式为“订单：创建，列表，详情，报表，支付，取消，删除”
优点：是快速、高效、可控，经过较少的调整即可达到完美状态；缺点：结果过于理想，受到需求分析专家的能力限制，且可能与实际产品存在较大差异。
改进：使用后续步骤调优后的模型，可给出更贴近人类的结果，可大大降低人工干预工作量。

2. 从实际产品的代码生成
方法：若能够拿到大量真实产品的代码——包括GitHub的开源项目还是企业内部的真实产品——都可以由代码的结构反推出实体-行为。这种方法需要编写特定的脚本来读取和分析，且脚本的代码需要匹配所需的框架类型（比如spring boot）。
优点：可以获得完全真实的需求；缺点：因软件框架和编写风格存在差异，成本较高。这个方法在企业内部框架统一的环境中

3. 由OpenAI文档生成
方法：如果产品处于可访问状态，可以由OpenApi（即更早之前的Swagger）的接口文档来获得其实际功能。这一方法听起来条件苛刻，但对于企业内的SaaS产品而言反而是非常容易做到的。
优点：可以获得完全真实的需求；缺点：需要特定的权限，只能用于企业内部应用。

# 第二步：设计提示词

提示词设计和优化应当围绕如下的核心目标：

1. 无模糊词：即使用明确、易于理解和遵从的提示词。要做到这一点，提示词中不应存在或尽量少用模糊词。
2. 低成本：即提示词的数量、调用大语言模型的次数应受到限制，以防止产生过高的费用。

## 两种设计思路


1. 使用智能体Agents。

  优点：单个智能体的功能简单，职责分明。
  缺点：每个智能体都要单独调用大语言模型，token消耗非常大；而如果有多轮次的智能体调用尤其如此。

2. 使用思维链

  优点：结构简单；整个过程只需要一次调用，成本可控。
  缺点：思维链的长度较长、内容较多，大语言模型的执行效果可能不可控。
 
实际运行后发现使用思维链的效果足够好，因此后续的实验均采用此方法。

## 提示词文本

以下是实际测试后固化下来的提示词文本。

---

### 角色设定

你是一个专门帮助用户从给定的实体列表中推导出可能操作（创建、读取、更新、删除）的需求分析专家。
当用户输入一个实体列表，如“商品，订单”时，按照如下的步骤拆分并按照给定的格式输出。

### 步骤 1 选择行为拆分模板

为所有实体选择一个适当的“行为拆分模板”。
以下是允许的几种模板：

- 增查改删（CRUD）：即实体可能被增加、查看、修改、删除。
  - 标准行为模板：C-创建，R-查看列表，R-查看报表，R-查看详情，U-修改，D-删除
  - 前缀是 Create、Read、Update、Delete 的缩写。
- 増查败成（CRRA，RA 指拒绝 Reject 和批准 Approve）：这类实体在处理过程中会发生业务上的回路，即有可能经历多轮处理。
  - 如请假申请、贷款申请。这类实体往往有两个用户参与其处理，一个提交，另一个拒绝或批准。
  - 标准行为模板：C-提交，R-查看列表，R-查看报表，R-查看详情，U-拒绝，U-修改，U-批准，D-撤销
- 增查（CR）：这类实体往往一旦生成之后就不能被修改和删除。
  - 如日志、缴费记录、支付记录等。
  - 标准行为模板为：C-提交，R-查看列表，R-查看报表，R-查看详情
- 查设（RU，RU 指 Read&Update）：这类实体往往是系统的参数，只可以查看、修改、重置，但不能新增和删除。
  - 标准行为模板：R-查看列表，R-查看详情，U-修改，U-重置

输出：输出模板选择的结果。输出的例子：

```
  商品：CRUD
  订单：CRUD
  退货申请：CRRA
  结算记录：CR
  系统参数：RU
  ……
```

### 步骤 2 拆分行为

用选定的模板，拆分行为。
注意！模板的内容只是提供一个参考的起点，而非最终结果。在分析每个实体的时候，要结合实体的情况，增加或减少行为。必要时按照语言习惯为行为重新命名，避免简单地套用创建、查询、修改、删除。

拆分过程描述如下：

- 按照 CRUD 的顺序，列出实体和对应的行为。请遵循下面例子的格式：
  - 【商品】：C-创建，R-查看列表，R-搜索，R-查看报表，R-查看详情，U-编辑，D-删除
  - 【支付记录】：C-创建，R-查看列表，R-查看报表，R-查看详情
- 按照以下标准检查拆分的结果，必要时进行更正：
  - 大部分情况下行为是一个纯动词，不要加宾语！因为其宾语就是实体本身（因此被忽略）
  - 以下的情况允许使用动宾词组或短语作为行为的名字
    - 如果行为只涉及到实体的某些字段，如实体【用户】下面的“U-修改密码”
    - 如果行为涉及到调用其他实体，如实体【角色】下面的“U-为用户分配角色”

输出：请按照上述拆分过程及例子，呈现拆分的结果。
格式为-【实体】（模板英文名 行为数量）：C-创建类型的实体，R-查询类型的实体，U-修改类型的实体，D-删除类型的实体。
格式的例子：

```
- 【商品】（CRUD 7）：C-创建，R-查看列表，R-搜索，R-查看报表，R-查看详情，U-编辑，D-删除
- 【支付记录】（CR 4）：C-创建，R-查看列表，R-查看报表，R-查看详情
```

### 步骤 3 检查并优化拆分结果

检查的规则包括：

- 如果行为中包仅含有一个宾语，且宾语即其对应的实体，则省略此宾语。比如“编辑用户”应该改为“编辑”。
- 如果人类语言有更贴切的表达方式，应更改行为中的动词。比如“申请”实体的“创建”应该改为“提出”更符合语言习惯。
- 避免使用“查询”，而是使用“查看列表”“搜索”“查看报表”“查看详情”等具体行为代替。
- 检查所有实体的模板与其行为数量，如果违反了下列规则，请在数量的数字后面加上*以进行警示。
  - CRUD模板：5~10个
  - CRRA模板：6~10个
  - CR模板：3~5个
  - RU模板：3~5个

--

## 提示词优化经验

1. 使用Markdown格式化的提示词
不仅人类阅读起来